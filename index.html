<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>IM KL - SM Insights Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    :root{
      --c1:#0C2B4E; /* deep */
      --c2:#1A3D64; /* mid */
      --c3:#1D546C; /* soft */
      --light:#F4F4F4;
      --bg:#f7f9fb;
      --card:#ffffff;
      --muted:#6b7280;
      --danger:#b32b2b;
      --danger-bg:#fff1f1;
      --disabled-opacity:0.45;
    }
    *{box-sizing:border-box}
    body{font-family:'EB Garamond', Georgia, serif;margin:0;background:var(--bg);color:#052034;display:flex;justify-content:center;padding:18px}
    .wrap{max-width:1160px;width:100%}
    .hero{border-radius:12px;padding:24px;margin-bottom:14px;overflow:hidden;background:linear-gradient(90deg,var(--c1),var(--c2));color:var(--light);box-shadow:0 12px 36px rgba(2,24,70,0.12);text-align:center}
    .hero h1{margin:0;font-size:22px;font-weight:700}
    .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;margin:14px 0;padding:12px;border-radius:10px;background:var(--card);box-shadow:0 8px 24px rgba(3,16,43,0.04)}
    .topbar input,.topbar select{padding:8px 12px;border-radius:8px;border:1px solid #e6eef9;font-size:14px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--c2);color:var(--light)}
    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;align-items:stretch;margin-bottom:16px}
    .kpi{padding:14px;border-radius:12px;color:var(--light);box-shadow:0 8px 20px rgba(3,16,43,0.06);text-align:center;min-height:80px;display:flex;flex-direction:column;justify-content:center}
    .kpi .label{font-size:13px;opacity:0.95}
    .kpi .value{font-size:20px;font-weight:700;margin-top:8px}
    .k1{background:linear-gradient(90deg,var(--c1),var(--c3))}
    .k2{background:linear-gradient(90deg,var(--c3),var(--c2))}
    .k3{background:linear-gradient(90deg,#87b8d9,#bfe0ee);color:#052034}
    .k4{background:linear-gradient(90deg,#cfeaf6,#eaf7fb);color:#052034}
    .k5{background:linear-gradient(90deg,var(--c1),var(--c2))}
    .pages-section{display:flex;justify-content:center;margin-bottom:16px}
    .pages-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;max-width:1000px;width:100%}
    .page-card{background:linear-gradient(180deg,var(--card),#f6fbfe);border-radius:12px;padding:14px;border:1px solid rgba(26,61,100,0.06);box-shadow:0 10px 22px rgba(10,30,50,0.04);display:flex;flex-direction:column;align-items:center;min-height:140px;transition:transform .5s cubic-bezier(.2,.9,.3,1),box-shadow .5s}
    .page-card.highlight{transform:translateY(-10px);box-shadow:0 30px 50px rgba(10,30,50,0.12);background:linear-gradient(180deg, rgba(29,84,108,0.06), rgba(26,61,100,0.03))}
    .page-title{font-weight:700;color:var(--c1);margin-bottom:8px;word-break:break-word}
    .page-metrics{font-size:13px;color:var(--muted);text-align:center}
    .metric-row{display:flex;gap:10px;justify-content:center;width:100%;margin-top:10px;flex-wrap:wrap}
    .metric-block{background:#fff;padding:8px 10px;border-radius:10px;border:1px solid #eef7fb;min-width:84px;text-align:center}
    .metric-value{font-weight:700;color:var(--c1);font-size:16px}
    .top-panels{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:12px;align-items:stretch}
    @media(max-width:980px){.top-panels{grid-template-columns:1fr}}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 26px rgba(3,16,43,0.04);display:flex;flex-direction:column}
    .panel .title{text-align:center;font-weight:700;color:var(--c1);margin-bottom:8px}
    .table-scroll{overflow:auto;max-height:380px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #eef6fb;text-align:left}
    .view-btn{background:var(--c3);color:var(--light);padding:6px 10px;border-radius:8px;text-decoration:none}
    .muted{color:var(--muted);font-size:13px}
    .disabled{opacity:var(--disabled-opacity);pointer-events:none;filter:grayscale(.05)}
    .no-data-alert{display:none;border-radius:10px;padding:18px;margin:12px 0;background:var(--danger-bg);border:1px solid rgba(179,43,43,0.12);color:var(--danger);font-weight:700;align-items:center;gap:12px}
    .no-data-alert.show{display:flex}
    .no-data-icon{width:40px;height:40px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:rgba(179,43,43,0.08);color:var(--danger);font-weight:900}
    .highlight-best{outline:4px solid rgba(29,84,108,0.08);border-radius:12px}
    @media(max-width:900px){.pages-grid{grid-template-columns:repeat(1,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>IM KL - SM Insights Dashboard</h1>
    </div>

    <div class="topbar">
      <label>From <input id="from" type="text" autocomplete="off" placeholder="YYYY-MM-DD"></label>
      <label>To <input id="to" type="text" autocomplete="off" placeholder="YYYY-MM-DD"></label>
      <label>Platform <select id="platformFilter"><option>All</option><option>Instagram</option><option>Facebook</option></select></label>
      <label>Page <select id="pageFilter"><option>All</option></select></label>
      <button id="refreshBtn" class="btn primary">Refresh</button>
      <button id="exportCsvBtn" class="btn">Export CSV</button>
    </div>

    <div id="noData" class="no-data-alert" role="alert" aria-live="assertive">
      <div class="no-data-icon">!</div>
      <div style="flex:1">
        <div style="font-size:18px">No data available for the selected filters.</div>
        <div style="font-size:13px;color:var(--muted)">Try widening the date range or selecting a different platform/page.</div>
      </div>
    </div>

    <div id="kpiRow" class="kpi-row"></div>

    <div class="pages-section">
      <div id="pagesList" class="pages-grid"></div>
    </div>

    <div class="top-panels">
      <div id="top5Panel" class="panel">
        <div class="title">Top 5 posts by views</div>
        <div id="top5Table" class="table-scroll"></div>
      </div>
      <div id="insightPanel" class="panel">
        <div class="title">Quick insights</div>
        <div id="quickInsights" class="muted" style="text-align:center"></div>
      </div>
    </div>

    <div id="fullPanel" class="panel">
      <div class="title">Full data</div>
      <div id="fullTable" class="table-scroll"></div>
    </div>

    <div style="margin-top:10px" class="muted">Notes: Rows with post_type == REEL are excluded. Refresh downloads CSV from: <code>https://docs.google.com/spreadsheets/d/1q8TX-YPZ4jMLJIe9h3AIpFKiGOKZWt8LZFzJKYjoN_I/export?format=csv&gid=0</code></div>
  </div>

<script>
  let RAW_DATA = [{"platform": "Instagram", "page_name": "Trivandrum Updates", "post_date": "2025-11-01", "content_title": "Dhyan Sreenivasan", "post_type": "IMAGE", "is_video": 0, "likes": 15, "comments": 1, "share": 1, "saves": 1, "views": 1700, "followers": 5, "permalink": "https://instagram.com/p/abc1", "eng_sum_raw": 18, "eng_rate_pct": 1.0588235294117647, "year_week": "2025-W44"}, {"platform": "Instagram", "page_name": "Trivandrum Updates", "post_date": "2025-11-03", "content_title": "Padmanabhaswamy Temple", "post_type": "IMAGE", "is_video": 0, "likes": 11, "comments": 1, "share": 1, "saves": 1, "views": 1311, "followers": 10, "permalink": "https://instagram.com/p/abc2", "eng_sum_raw": 14, "eng_rate_pct": 1.0678871090770405, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Trivandrum Updates", "post_date": "2025-11-03", "content_title": "PM Shri", "post_type": "IMAGE", "is_video": 0, "likes": 7, "comments": 1, "share": 1, "saves": 1, "views": 678, "followers": 10, "permalink": "https://instagram.com/p/abc3", "eng_sum_raw": 10, "eng_rate_pct": 1.4749262536873156, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Trivandrum Updates", "post_date": "2025-11-04", "content_title": "Varkala harassment", "post_type": "IMAGE", "is_video": 0, "likes": 3, "comments": 1, "share": 1, "saves": 1, "views": 215, "followers": 20, "permalink": "https://instagram.com/p/abc4", "eng_sum_raw": 6, "eng_rate_pct": 2.7906976744186047, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Ernakulam Now", "post_date": "2025-11-02", "content_title": "New education reforms explaineda", "post_type": "IMAGE", "is_video": 0, "likes": 180, "comments": 14, "share": 6, "saves": 12, "views": 2400, "followers": 10, "permalink": "https://instagram.com/p/abc5", "eng_sum_raw": 212, "eng_rate_pct": 8.833333333333334, "year_week": "2025-W44"}, {"platform": "Instagram", "page_name": "Ernakulam Now", "post_date": "2025-11-06", "content_title": "Interview: Voices of the young votersa", "post_type": "VIDEO", "is_video": 1, "likes": 12, "comments": 2, "share": 4, "saves": 2, "views": 6100, "followers": 20, "permalink": "https://instagram.com/p/abc6", "eng_sum_raw": 20, "eng_rate_pct": 0.32786885245901637, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Patti Show", "post_date": "2025-11-03", "content_title": "Street art against corruptiona", "post_type": "IMAGE", "is_video": 0, "likes": 150, "comments": 10, "share": 5, "saves": 9, "views": 2000, "followers": 10, "permalink": "https://instagram.com/p/abc7", "eng_sum_raw": 174, "eng_rate_pct": 8.7, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Patti Show", "post_date": "2025-11-10", "content_title": "Farmers discuss sustainable futuresa", "post_type": "VIDEO", "is_video": 1, "likes": 310, "comments": 26, "share": 17, "saves": 23, "views": 4700, "followers": 10, "permalink": "https://instagram.com/p/abc8", "eng_sum_raw": 376, "eng_rate_pct": 8.0, "year_week": "2025-W46"}, {"platform": "Facebook", "page_name": "Kozhikode Daily", "post_date": "2025-11-03", "content_title": "aCitizens raise voice on civic issuesa", "post_type": "IMAGE", "is_video": 0, "likes": 140, "comments": 8, "share": 12, "saves": 10, "views": 2800, "followers": 10, "permalink": "https://facebook.com/p/abc9", "eng_sum_raw": 170, "eng_rate_pct": 6.071428571428571, "year_week": "2025-W45"}, {"platform": "Facebook", "page_name": "INC.Kerala", "post_date": "2025-11-05", "content_title": "aExclusive: Interview with mayoral candidatea", "post_type": "VIDEO", "is_video": 1, "likes": 480, "comments": 38, "share": 28, "saves": 33, "views": 7000, "followers": 10, "permalink": "https://facebook.com/p/abc10", "eng_sum_raw": 579, "eng_rate_pct": 8.27142857142857, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "INC.Kerala", "post_date": "2025-11-05", "content_title": "aExclusive: Interview with mayoral candidatea", "post_type": "VIDEO", "is_video": 1, "likes": 480, "comments": 38, "share": 28, "saves": 33, "views": 7000, "followers": 10, "permalink": "https://facebook.com/p/abc10", "eng_sum_raw": 579, "eng_rate_pct": 8.27142857142857, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Janangalude Congress", "post_date": "2025-11-04", "content_title": "aExclusive: Interview with mayoral candidatea", "post_type": "VIDEO", "is_video": 1, "likes": 480, "comments": 38, "share": 28, "saves": 33, "views": 7000, "followers": 10, "permalink": "https://facebook.com/p/abc11", "eng_sum_raw": 579, "eng_rate_pct": 8.27142857142857, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "Janangalude Congress", "post_date": "2025-11-05", "content_title": "aExclusive: Interview with mayoral candidatea", "post_type": "VIDEO", "is_video": 1, "likes": 480, "comments": 38, "share": 28, "saves": 33, "views": 7000, "followers": 20, "permalink": "https://facebook.com/p/abc12", "eng_sum_raw": 579, "eng_rate_pct": 8.27142857142857, "year_week": "2025-W45"}, {"platform": "Instagram", "page_name": "JC", "post_date": "2025-11-06", "content_title": "aExclusive: Interview with mayoral candidatea", "post_type": "VIDEO", "is_video": 1, "likes": 480, "comments": 38, "share": 28, "saves": 33, "views": 7000, "followers": 10, "permalink": "https://facebook.com/p/abc13", "eng_sum_raw": 579, "eng_rate_pct": 8.27142857142857, "year_week": "2025-W45"}];
  const CSV_URL = "https://docs.google.com/spreadsheets/d/1q8TX-YPZ4jMLJIe9h3AIpFKiGOKZWt8LZFzJKYjoN_I/export?format=csv&gid=0";
  const APPS_SCRIPT_FALLBACK = "https://script.google.com/macros/s/AKfycbyD2XixYqutXLNbrhNlWfZI333aYIs8L1OZEDfON48Zf2gcar6c_RYUfb7-JgthEsdK/exec";

  // Date helpers (local midnight comparisons)
  function parseDateSafe(s){
    if(!s) return null;
    const str = String(s).trim();
    if(!str) return null;
    const m = str.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
    if(m){
      const y=Number(m[1]), mo=Number(m[2])-1, d=Number(m[3]);
      if(!isNaN(y) && !isNaN(mo) && !isNaN(d)) return new Date(y,mo,d);
    }
    const dt = new Date(str);
    if(!isNaN(dt)) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    const parts = str.split(/[-\/]/);
    if(parts.length>=3){
      const y=Number(parts[0]), mo=Number(parts[1])-1, d=Number(parts[2]);
      if(!isNaN(y) && !isNaN(mo) && !isNaN(d)) return new Date(y,mo,d);
    }
    return null;
  }
  function dateOnly(d){ if(!d) return null; return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  const MONTHS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  function fmtDate(s){ const d=parseDateSafe(s); if(!d) return ''; return `${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`; }

  // robust CSV line parser (handles quoted fields)
  function parseCsvLine(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; }
      if(ch==='"'){ inQ=!inQ; continue; }
      if(ch===',' && !inQ){ out.push(cur); cur=''; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out;
  }

  // prepare rows
  function prepareRows(rawRows){
    const rows = (rawRows||[]).map(r=>{
      return {
        platform: (r.platform||'').toString().trim(),
        page_name: (r.page_name||'').toString().trim(),
        post_date: (r.post_date||r.post_date_string||'').toString().trim(),
        content_title: (r.content_title||'').toString().trim(),
        post_type: (r.post_type||'').toString().toUpperCase().trim(),
        is_video: Number(r.is_video||0),
        likes: Number(r.likes||0),
        comments: Number(r.comments||0),
        share: Number(r.share||0),
        saves: Number(r.saves||0),
        views: Number(r.views||0),
        followers: Number(r.followers||0),
        permalink: (r.permalink||'').toString().trim()
      };
    });

    function isValidRow(r){
      const hasDate = !!parseDateSafe(r.post_date);
      const hasTitle = (r.content_title||'').length>0;
      const hasPage = (r.page_name||'').length>0;
      const engagementSum = (Number(r.likes)||0) + (Number(r.comments)||0) + (Number(r.share)||0) + (Number(r.saves)||0) + (Number(r.views)||0);
      return (hasPage && (hasDate || hasTitle || engagementSum>0)) || engagementSum>0 || hasDate || hasTitle;
    }

    let filtered = rows.filter(r => (r.post_type||'').toUpperCase() !== 'REEL').filter(isValidRow);

    filtered.forEach(r=>{
      r.post_date_obj = parseDateSafe(r.post_date);
      r.post_date_display = fmtDate(r.post_date);
      const sum = (Number(r.likes)||0) + (Number(r.comments)||0) + (Number(r.share)||0) + (Number(r.saves)||0);
      r.eng_sum_raw = sum;
      r.eng_rate_pct = (sum / Math.max(Number(r.views)||0, 1)) * 100;
    });
    return filtered;
  }

  function populatePageFilter(rows){
    const sel = document.getElementById('pageFilter');
    const pages = Array.from(new Set(rows.map(r=>r.page_name))).filter(x=>x);
    const current = sel.value || 'All';
    sel.innerHTML = '<option>All</option>';
    pages.forEach(p => { const o=document.createElement('option'); o.value=p; o.text=p; sel.appendChild(o); });
    if(Array.from(sel.options).some(opt=>opt.value===current)) sel.value = current;
  }

  function followersByPageAt(rows, uptoDate){
    const byPage = {};
    rows.forEach(r=>{
      const d = r.post_date_obj || null;
      if(!d && uptoDate) return;
      if(uptoDate && d){
        if(dateOnly(d).getTime() > dateOnly(uptoDate).getTime()) return;
      }
      const key = r.page_name || '';
      const t = d ? dateOnly(d).getTime() : 0;
      if(!byPage[key] || (byPage[key].date||0) < t){
        byPage[key] = { val: r.followers||0, date: t };
      }
    });
    return byPage;
  }

  // -------- render --------
  function renderKPIs(filtered){
    const allRows = prepareRows(RAW_DATA);
    const latestByPageAll = followersByPageAt(allRows, null);

    const pagesInView = Array.from(new Set(filtered.map(r=>r.page_name))).filter(x=>x);
    const platformSel = document.getElementById('platformFilter').value || 'All';
    let pagesToSum = pagesInView.slice();
    if(pagesToSum.length === 0 && platformSel !== 'All'){
      pagesToSum = Array.from(new Set(allRows.filter(r=>r.platform === platformSel).map(r=>r.page_name))).filter(x=>x);
    }
    if(pagesToSum.length === 0){
      pagesToSum = Object.keys(latestByPageAll);
    }
    const total_followers = pagesToSum.reduce((s,p)=> s + ((latestByPageAll[p] && latestByPageAll[p].val) || 0), 0);

    const validFiltered = prepareRows(filtered);
    const total_posts = validFiltered.length;
    const total_videos = validFiltered.filter(r=>r.post_type === 'VIDEO').length;
    const total_views = validFiltered.reduce((s,r)=> s + (r.views||0), 0);
    const total_eng_sum = validFiltered.reduce((s,r)=> s + (r.eng_rate_pct || 0), 0).toFixed(1);

    const kpiRow = document.getElementById('kpiRow');
    const cards = [
      {cls:'k1', label:'Total engagement (sum %)', value: total_eng_sum},
      {cls:'k2', label:'Total followers', value: total_followers},
      {cls:'k3', label:'Total views', value: total_views},
      {cls:'k4', label:'Total posts', value: total_posts},
      {cls:'k5', label:'Total videos', value: total_videos},
    ];
    kpiRow.innerHTML = cards.map(c=>`<div class="kpi ${c.cls}"><div class="label">${c.label}</div><div class="value">${c.value}</div></div>`).join('');
  }

  function renderPagesGrid(allRowsPrepared, filteredPrepared){
    const pageSel = document.getElementById('pageFilter').value || 'All';
    const all = prepareRows(allRowsPrepared);
    const filtered = prepareRows(filteredPrepared);

    // If a specific page is selected, only show pages present in filtered rows.
    let pages = [];
    if(pageSel !== 'All'){
      pages = Array.from(new Set(filtered.map(r=>r.page_name))).filter(x=>x);
    } else {
      pages = Array.from(new Set(all.map(r=>r.page_name))).filter(x=>x);
      pages = pages.filter(p => all.some(r=>r.page_name === p));
    }

    const container = document.getElementById('pagesList');
    let html = '';
    const byPageViews = {};
    filtered.forEach(r => { byPageViews[r.page_name] = (byPageViews[r.page_name]||0) + (r.views||0); });
    const bestPage = Object.keys(byPageViews).length ? Object.entries(byPageViews).sort((a,b)=>b[1]-a[1])[0][0] : null;

    pages.forEach(p=>{
      const pageAll = all.filter(r=>r.page_name===p).slice().sort((a,b)=> (a.post_date_obj? a.post_date_obj.getTime():0) - (b.post_date_obj? b.post_date_obj.getTime():0));
      const pageFiltered = filtered.filter(r=>r.page_name===p);
      if(pageSel !== 'All' && pageFiltered.length === 0) return;
      const latestFollowers = pageAll.length ? (pageAll[pageAll.length-1].followers || 0) : 0;
      let followers_change = 0;
      if(pageFiltered.length >= 2){
        const earliest = pageFiltered.slice().sort((a,b)=> (a.post_date_obj? a.post_date_obj.getTime():0) - (b.post_date_obj? b.post_date_obj.getTime():0))[0].followers || 0;
        const latest = pageFiltered.slice().sort((a,b)=> (b.post_date_obj? b.post_date_obj.getTime():0) - (a.post_date_obj? a.post_date_obj.getTime():0))[0].followers || 0;
        followers_change = latest - earliest;
      }
      const totalEng = pageFiltered.reduce((s,r)=> s + (r.eng_rate_pct||0), 0).toFixed(1);
      const postsCount = pageFiltered.length;
      const videosCount = pageFiltered.filter(r=>r.post_type === 'VIDEO').length;
      const cardClass = (bestPage && bestPage === p) ? 'page-card highlight' : 'page-card';
      html += `<div class="${cardClass}"><div class="page-title">${p}</div><div class="page-metrics">Followers: <strong>${latestFollowers}</strong> <span style="color:${followers_change>=0?'#0b6b3a':'#b02a2a'}">${followers_change>=0?'+':''}${followers_change}</span></div><div class="metric-row"><div class="metric-block"><div style="font-size:12px;color:var(--muted)">Eng</div><div class="metric-value">${totalEng}%</div></div><div class="metric-block"><div style="font-size:12px;color:var(--muted)">Posts</div><div class="metric-value">${postsCount}</div></div><div class="metric-block"><div style="font-size:12px;color:var(--muted)">Videos</div><div class="metric-value">${videosCount}</div></div></div></div>`;
    });

    container.innerHTML = html || '<div style="text-align:center;color:var(--muted);padding:18px">No pages to display</div>';
  }

  function renderTop5(filtered){
    const valid = prepareRows(filtered);
    if(valid.length === 0){
      document.getElementById('top5Table').innerHTML = '<div style="text-align:center;color:var(--muted);padding:18px">No posts in view</div>';
      return;
    }
    const top = valid.slice().sort((a,b)=>b.views - a.views).slice(0,5);
    let html = '<table><thead><tr><th>#</th><th>Platform</th><th>Page</th><th>Date</th><th>Title</th><th>Views</th><th></th></tr></thead><tbody>';
    top.forEach((r,i)=>{
      const t = r.content_title.length>80? r.content_title.slice(0,77)+'...' : r.content_title;
      const btn = r.permalink ? `<a class="view-btn" href="${r.permalink}" target="_blank">View</a>` : '';
      html += `<tr><td>${i+1}</td><td>${r.platform}</td><td>${r.page_name}</td><td>${r.post_date_display}</td><td>${t}</td><td style="text-align:right">${r.views}</td><td style="text-align:right">${btn}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('top5Table').innerHTML = html;
  }

  function renderFullTable(filtered){
    const valid = prepareRows(filtered);
    if(valid.length === 0){
      document.getElementById('fullTable').innerHTML = '<div style="text-align:center;color:var(--muted);padding:18px">No posts in view</div>';
      return;
    }
    let html = '<table><thead><tr><th>Platform</th><th>Page</th><th>Date</th><th>Title</th><th>Type</th><th>Likes</th><th>Comments</th><th>Share</th><th>Saves</th><th>Views</th><th>Followers</th><th></th></tr></thead><tbody>';
    valid.forEach(r=>{
      const t = r.content_title.length>100? r.content_title.slice(0,97)+'...' : r.content_title;
      const btn = r.permalink ? `<a class="view-btn" href="${r.permalink}" target="_blank">View</a>` : '';
      html += `<tr><td>${r.platform}</td><td>${r.page_name}</td><td>${r.post_date_display}</td><td>${t}</td><td>${r.post_type}</td><td>${r.likes}</td><td>${r.comments}</td><td>${r.share}</td><td>${r.saves}</td><td>${r.views}</td><td>${r.followers}</td><td style="text-align:right">${btn}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('fullTable').innerHTML = html;
  }

  function renderQuickInsights(filtered){
    const valid = prepareRows(filtered);
    if(valid.length === 0){
      document.getElementById('quickInsights').innerHTML = `No data`;
      return;
    }
    const totalViews = valid.reduce((s,r)=>s+(r.views||0),0);
    const avgEng = valid.length ? (valid.reduce((s,r)=>s+(r.eng_rate_pct||0),0)/valid.length).toFixed(1) : '0.0';
    const totalPosts = valid.length;
    const totalVideos = valid.filter(r=>r.post_type === 'VIDEO').length;
    document.getElementById('quickInsights').innerHTML = `Posts in view: <strong>${totalPosts}</strong> • Videos: <strong>${totalVideos}</strong><br/>Total views: <strong>${totalViews}</strong> • Avg engagement: <strong>${avgEng}%</strong>`;
  }

  function downloadCsv(rows){
    const header = ['platform','page_name','post_date','content_title','post_type','is_video','likes','comments','share','saves','views','followers','permalink'];
    const lines = [header.join(',')];
    rows.forEach(r=>{ const line = header.map(h=>`"${String(r[h]!==undefined?r[h]:'').replace(/"/g,'""')}"`).join(','); lines.push(line); });
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='filtered_data.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // main pipeline
  function renderFromRows(rawRows){
    const prepared = prepareRows(rawRows);
    populatePageFilter(prepared);
    const fromVal=document.getElementById('from').value;
    const toVal=document.getElementById('to').value;
    const pageSel=document.getElementById('pageFilter').value || 'All';
    const platformSel=document.getElementById('platformFilter').value || 'All';
    const fromDate = fromVal? parseDateSafe(fromVal) : null;
    const toDate = toVal? parseDateSafe(toVal) : null;

    const filtered = prepared.filter(r=>{
      if(fromDate && r.post_date_obj && dateOnly(r.post_date_obj).getTime() < dateOnly(fromDate).getTime()) return false;
      if(toDate && r.post_date_obj && dateOnly(r.post_date_obj).getTime() > dateOnly(toDate).getTime()) return false;
      if(pageSel !== 'All' && r.page_name !== pageSel) return false;
      if(platformSel !== 'All' && r.platform !== platformSel) return false;
      return true;
    });

    const noDataEl = document.getElementById('noData');
    const panels = ['top5Panel','insightPanel','fullPanel','kpiRow','pagesList'];
    if(filtered.length === 0){
      noDataEl.classList.add('show');
      panels.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.classList.add('disabled');
      });
    } else {
      noDataEl.classList.remove('show');
      panels.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.classList.remove('disabled');
      });
    }

    renderKPIs(filtered);
    renderPagesGrid(prepared, filtered);
    renderTop5(filtered);
    renderFullTable(filtered);
    renderQuickInsights(filtered);
    document.getElementById('exportCsvBtn').onclick = ()=> downloadCsv(filtered);
  }

  // initial render
  renderFromRows(RAW_DATA);

  // controls
  document.getElementById('pageFilter').addEventListener('change', ()=> renderFromRows(RAW_DATA));
  document.getElementById('platformFilter').addEventListener('change', ()=> renderFromRows(RAW_DATA));
  document.getElementById('from').addEventListener('change', ()=> renderFromRows(RAW_DATA));
  document.getElementById('to').addEventListener('change', ()=> renderFromRows(RAW_DATA));

  // init flatpickr
  document.addEventListener('DOMContentLoaded', function(){
    if(typeof flatpickr === 'function'){
      flatpickr("#from", { dateFormat: "Y-m-d", clickOpens: true, allowInput: true });
      flatpickr("#to",   { dateFormat: "Y-m-d", clickOpens: true, allowInput: true });
    }
  });

  // Refresh button: CSV then Apps Script fallback
  document.getElementById('refreshBtn').addEventListener('click', async ()=>{
    const btn = document.getElementById('refreshBtn');
    try{
      btn.textContent = 'Refreshing...';
      try {
        const resp = await fetch(CSV_URL, { cache: 'no-store' });
        if(!resp.ok) throw new Error('CSV HTTP ' + resp.status);
        let text = await resp.text();
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split('\n');
        while(lines.length && lines[0].trim() === '') lines.shift();
        while(lines.length && lines[lines.length-1].trim() === '') lines.pop();
        if(lines.length < 1) throw new Error('CSV returned no rows');

        const headers = parseCsvLine(lines[0]).map(h=>h.trim());
        const rows = [];
        for(let i=1;i<lines.length;i++){
          const raw = lines[i];
          if(raw.trim()==='') continue;
          const vals = parseCsvLine(raw);
          if(vals.length < headers.length){
            while(vals.length < headers.length) vals.push('');
          } else if(vals.length > headers.length){
            const extras = vals.slice(headers.length-1).join(',');
            vals.splice(headers.length-1, vals.length - (headers.length-1), extras);
          }
          const obj = {};
          for(let j=0;j<headers.length;j++){
            const key = headers[j] || `col${j}`;
            obj[key] = vals[j] !== undefined ? vals[j] : '';
          }
          rows.push(obj);
        }

        RAW_DATA = rows;
        renderFromRows(RAW_DATA);
        btn.textContent = 'Refresh';
        return;
      } catch(csvErr){
        console.warn('CSV fetch/parse failed:', csvErr);
      }

      if(APPS_SCRIPT_FALLBACK && APPS_SCRIPT_FALLBACK.length > 10){
        try {
          const resp2 = await fetch(APPS_SCRIPT_FALLBACK, { cache: 'no-store' });
          if(!resp2.ok) throw new Error('AppsScript HTTP ' + resp2.status);
          const payload = await resp2.json();
          if(Array.isArray(payload)) {
            RAW_DATA = payload;
          } else if(payload && Array.isArray(payload.rows)) {
            RAW_DATA = payload.rows;
          } else {
            throw new Error('Unexpected JSON shape from AppsScript');
          }
          renderFromRows(RAW_DATA);
          btn.textContent = 'Refresh';
          return;
        } catch(jsErr){
          console.warn('Apps Script fallback failed:', jsErr);
        }
      }

      throw new Error('Both CSV fetch and Apps Script JSON fallback failed. Check sheet sharing or provide a working Apps Script URL.');
    } catch(err){
      console.error('Refresh failed:', err);
      alert('Refresh failed: ' + err + '\n\nTips:\n - If your sheet is private, deploy an Apps Script web-app and pass its URL with --apps-script-url when running the generator.\n - Or make the sheet "Anyone with link - Viewer" and try again.');
      btn.textContent = 'Refresh';
    }
  });
</script>
</body>
</html>
